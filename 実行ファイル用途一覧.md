# 実行ファイル用途一覧

本書は、四季報オンラインの取得スクリプト（scrape.py）とサマリー生成スクリプト（summary.py）の用途・入出力・主なオプション・実行例を一覧化したものです。

## 前提
- パッケージ管理: uv（AGENTS.md準拠）
- Python: 3.9+（本プロジェクトは 3.9 で動作確認）
- 文字コード: 入出力CSVは UTF-8（BOM付き）

## 実行ファイル一覧

### scrape.py（銘柄データ取得）
- 用途: 四季報オンライン `https://shikiho.toyokeizai.net/stocks/{code}` から項目を取得しCSV出力
- 入力: `codelist.csv`（ヘッダ `code` 必須）
- 出力: 既定は `result.csv`（UTF-8 BOM）。実運用では日付付き `YYYYMMDD_result.csv` を推奨
- 抽出項目: `code, company_name, market, feature, business_composition, industries, themes`
- 代表オプション
  - `--input / --output / --sleep / --limit`
  - `--retries / --retry-base / --retry-factor / --retry-max / --jitter-frac`
  - `--resume / --append / --failures / --failures-auto / --from-failures`
  - `--headed / --headless / --timeout / --nav-timeout / --user-agent`
  - `--fields / --max-industries / --eta-interval / --verbose`
- 初回セットアップ（Chromium インストール）
  - `uv run python -m playwright install chromium`
- よく使う実行例
  - 単体確認（1件）: `uv run python scrape.py --limit 1`
  - 先頭N件: `uv run python scrape.py --limit 2 --sleep 1.2`
  - 全件（サイト配慮）: `uv run python scrape.py --sleep 5.0`
  - ブラウザ表示: `uv run python scrape.py --headed --limit 1 --verbose`
  - レジューム: `uv run python scrape.py --resume`
  - 失敗CSV出力: `uv run python scrape.py --failures-auto`
  - 失敗CSVから再実行: `uv run python scrape.py --from-failures failures.csv --append`

### summary.py（集計CSV生成）
- 用途: `business_composition` を解析し、上位3事業と海外売上比率を展開した `YYYYMMDD_summary.csv` を出力
- 入力: `YYYYMMDD_result.csv`
- 出力: `YYYYMMDD_summary.csv`（自動命名。`--output` で明示指定可）
- 追加カラム（`themes` の右側に挿入）
  - `business1,business2,business3`
  - `business_sales1,business_sales2,business_sales3`
  - `business_profit1,business_profit2,business_profit3`
  - `overseas`
- 解析仕様（要点）
  - 事業: 例 `水産55(3)` → 名称=水産, 売上寄与度=55, 利益率=3（整数）
  - 区切り: `、` または `,`
  - 「他」は除外。売上寄与度の降順で上位3件（同率は元順）
  - 海外比率: `【海外】n` の整数 `n` を抽出（無い場合は空欄）
  - 末尾の補足（例 `<25.3>`）は無視
- 実行例
  - 基本: `uv run python summary.py --input 20250914_result.csv`
  - 出力を明示: `uv run python summary.py --input 20250914_result.csv --output ./out/summary.csv`

## 典型フロー
1) ブラウザ準備（初回のみ）: `uv run python -m playwright install chromium`
2) 取得: `uv run python scrape.py --sleep 5.0 --output 20250914_result.csv`
3) 集計: `uv run python summary.py --input 20250914_result.csv`
4) 必要に応じレジューム/失敗対応
   - `uv run python scrape.py --resume`
   - `uv run python scrape.py --from-failures failures_YYYYMMDD_HHMM.csv --append`

## トラブルシュート（要点）
- Playwright 未インストール: 上記セットアップコマンドを実行
- タイムアウト: `--sleep` や `--timeout` / `--nav-timeout` を増やす。`--headed` で目視確認
- CSV 文字化け: 出力は UTF-8 BOM。Excel での表示を推奨
- summary の必須列不足: 入力CSVのヘッダに `business_composition` 等があるか確認

